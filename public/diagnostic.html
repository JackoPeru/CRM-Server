<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostica CRM Marmeria</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .success { color: #4CAF50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .info { color: #2196F3; font-weight: bold; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        .log { 
            background: rgba(0,0,0,0.3); 
            padding: 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostica Avanzata CRM Marmeria</h1>
        <p>Questa pagina esegue test diagnostici per identificare problemi di caricamento.</p>
        
        <div class="test-section">
            <h3>üìä Stato Sistema</h3>
            <div id="system-status">‚è≥ Controllo in corso...</div>
        </div>
        
        <div class="test-section">
            <h3>üîß Test Moduli</h3>
            <div id="module-tests">‚è≥ Test in corso...</div>
            <button onclick="testModules()">üîÑ Ripeti Test Moduli</button>
        </div>
        
        <div class="test-section">
            <h3>üåê Test Connettivit√†</h3>
            <div id="connectivity-tests">‚è≥ Test in corso...</div>
            <button onclick="testConnectivity()">üîÑ Test Connettivit√†</button>
        </div>
        
        <div class="test-section">
            <h3>üìù Log Console</h3>
            <div id="console-log" class="log"></div>
            <button onclick="clearLog()">üóëÔ∏è Pulisci Log</button>
        </div>
        
        <div class="test-section">
            <h3>üöÄ Azioni</h3>
            <button onclick="window.open('/', '_blank')">üè† Apri App Principale</button>
            <button onclick="window.open('/debug-react.html', '_blank')">üß™ Test React</button>
            <button onclick="window.location.reload()">üîÑ Ricarica Diagnostica</button>
        </div>
    </div>
    
    <script>
        let logContainer = document.getElementById('console-log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[Diagnostic] ${message}`);
        }
        
        function clearLog() {
            logContainer.textContent = '';
        }
        
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            let status = [];
            
            // Check browser
            status.push(`<span class="info">üåê Browser:</span> ${navigator.userAgent}`);
            status.push(`<span class="info">üì± Platform:</span> ${navigator.platform}`);
            status.push(`<span class="info">üîó URL:</span> ${window.location.href}`);
            status.push(`<span class="info">‚è∞ Timestamp:</span> ${new Date().toLocaleString()}`);
            
            // Check localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                status.push(`<span class="success">‚úÖ LocalStorage:</span> Funzionante`);
            } catch (e) {
                status.push(`<span class="error">‚ùå LocalStorage:</span> ${e.message}`);
            }
            
            // Check IndexedDB
            try {
                if ('indexedDB' in window) {
                    status.push(`<span class="success">‚úÖ IndexedDB:</span> Supportato`);
                } else {
                    status.push(`<span class="error">‚ùå IndexedDB:</span> Non supportato`);
                }
            } catch (e) {
                status.push(`<span class="error">‚ùå IndexedDB:</span> ${e.message}`);
            }
            
            statusDiv.innerHTML = status.join('<br>');
            log('Sistema controllato');
        }
        
        async function testModules() {
            const testDiv = document.getElementById('module-tests');
            let results = [];
            
            log('Inizio test moduli...');
            
            // Test React import
            try {
                const React = await import('/node_modules/react/index.js');
                results.push(`<span class="success">‚úÖ React:</span> Caricato (v${React.version || 'unknown'})`);
                log('React importato con successo');
            } catch (e) {
                results.push(`<span class="error">‚ùå React:</span> ${e.message}`);
                log(`Errore React: ${e.message}`);
            }
            
            // Test ReactDOM import
            try {
                await import('/node_modules/react-dom/client.js');
                results.push(`<span class="success">‚úÖ ReactDOM:</span> Caricato`);
                log('ReactDOM importato con successo');
            } catch (e) {
                results.push(`<span class="error">‚ùå ReactDOM:</span> ${e.message}`);
                log(`Errore ReactDOM: ${e.message}`);
            }
            
            // Test main.jsx
            try {
                await import('/src/main.jsx');
                results.push(`<span class="success">‚úÖ main.jsx:</span> Caricato`);
                log('main.jsx importato con successo');
            } catch (e) {
                results.push(`<span class="error">‚ùå main.jsx:</span> ${e.message}`);
                log(`Errore main.jsx: ${e.message}`);
            }
            
            testDiv.innerHTML = results.join('<br>');
            log('Test moduli completato');
        }
        
        async function testConnectivity() {
            const testDiv = document.getElementById('connectivity-tests');
            let results = [];
            
            log('Inizio test connettivit√†...');
            
            // Test server locale
            try {
                const response = await fetch('/');
                if (response.ok) {
                    results.push(`<span class="success">‚úÖ Server Locale:</span> Raggiungibile (${response.status})`);
                } else {
                    results.push(`<span class="warning">‚ö†Ô∏è Server Locale:</span> Status ${response.status}`);
                }
                log(`Server locale: ${response.status}`);
            } catch (e) {
                results.push(`<span class="error">‚ùå Server Locale:</span> ${e.message}`);
                log(`Errore server locale: ${e.message}`);
            }
            
            // Test backend API
            try {
                const response = await fetch('http://localhost:3001/api/health');
                if (response.ok) {
                    results.push(`<span class="success">‚úÖ Backend API:</span> Raggiungibile`);
                } else {
                    results.push(`<span class="warning">‚ö†Ô∏è Backend API:</span> Status ${response.status}`);
                }
                log(`Backend API: ${response.status}`);
            } catch (e) {
                results.push(`<span class="error">‚ùå Backend API:</span> ${e.message}`);
                log(`Backend API non raggiungibile: ${e.message}`);
            }
            
            testDiv.innerHTML = results.join('<br>');
            log('Test connettivit√† completato');
        }
        
        // Intercetta errori
        window.addEventListener('error', (event) => {
            log(`ERRORE: ${event.error?.message || event.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            log(`PROMISE REJECTION: ${event.reason}`, 'error');
        });
        
        // Avvia diagnostica
        log('üîç Diagnostica CRM Marmeria avviata');
        checkSystemStatus();
        testModules();
        testConnectivity();
    </script>
</body>
</html>